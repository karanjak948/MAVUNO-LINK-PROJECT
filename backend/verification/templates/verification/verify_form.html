{% extends "verification/base.html" %}
{% block title %}Verify Product - MavunoLink{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="fw-bold text-success mb-4">Product Verification</h2>
  <p class="text-muted">
    Enter the product code manually or use the camera scanner to check authenticity.
  </p>

  <!-- Manual Entry -->
  <form method="post" action="{% url 'verify_product_page' %}" class="mt-3">
    {% csrf_token %}
    <div class="mb-3">
      <label for="barcode" class="form-label fw-semibold">Product Code</label>
      <input
        type="text"
        id="barcode"
        name="barcode"
        class="form-control"
        placeholder="e.g. ABC123XYZ"
        required
      >
    </div>
    <button type="submit" class="btn btn-success">Verify</button>
  </form>

  <hr class="my-4">

  <!-- Barcode Scanner -->
  <h4 class="fw-bold text-primary">ðŸ“· Scan Barcode</h4>
  <p class="text-muted">Allow camera access and hold the product barcode in front of your camera.</p>

  <div id="scanner-container" class="border rounded p-3 bg-light text-center">
    <video id="scanner" style="width:100%; max-height:300px;" autoplay muted></video>
  </div>
  <button id="start-scan" class="btn btn-outline-primary mt-3">Start Scanning</button>
  <button id="stop-scan" class="btn btn-outline-danger mt-3 d-none">Stop Scanning</button>
</div>

<!-- QuaggaJS for Barcode Scanning -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
  const startBtn = document.getElementById("start-scan");
  const stopBtn = document.getElementById("stop-scan");
  const inputField = document.getElementById("barcode");

  startBtn.addEventListener("click", () => {
    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector("#scanner"), 
        constraints: {
          facingMode: "environment" // use back camera
        }
      },
      decoder: {
        readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader"]
      }
    }, function(err) {
      if (err) {
        console.error(err);
        return;
      }
      Quagga.start();
      startBtn.classList.add("d-none");
      stopBtn.classList.remove("d-none");
    });

    Quagga.onDetected(result => {
      let code = result.codeResult.code;
      inputField.value = code; // auto-fill the form
      alert("âœ… Barcode detected: " + code);
      Quagga.stop();
      startBtn.classList.remove("d-none");
      stopBtn.classList.add("d-none");
    });
  });

  stopBtn.addEventListener("click", () => {
    Quagga.stop();
    startBtn.classList.remove("d-none");
    stopBtn.classList.add("d-none");
  });
</script>
{% endblock %}
